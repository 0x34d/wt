WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",(function(e,t,n){t.wtLObj=this;var i=this,o=e.WT,a="Wt-dropzone-hover",r="Wt-dropzone-indication",s="Wt-dropzone-dragstyle",d=[],l=!1,u=!0,f=!1,c=!1,p=void 0,v=0,h=0,g=document.createElement("input");g.type="file";g.setAttribute("multiple","multiple");g.style.display="none";t.appendChild(g);var m=document.createElement("div");m.classList.add("Wt-dropcover");document.body.appendChild(m);this.eventContainsFile=function(e){var t=null!=e.dataTransfer.items&&e.dataTransfer.items.length>0&&"file"===e.dataTransfer.items[0].kind,n=null!=e.dataTransfer.types&&e.dataTransfer.types.length>0&&"Files"===e.dataTransfer.types[0];return t||n};this.validFileCheck=function(e,t,n){var i=new FileReader;i.onload=function(){t(!0,n)};i.onerror=function(){t(!1,n)};i.readAsText(e.slice(0,32))};t.setAcceptDrops=function(e){u=e};t.setDropIndication=function(e){f=e};t.setDropForward=function(e){c=e};t.ondragenter=function(e){if(u){if(i.eventContainsFile(e)){0===h&&i.setPageHoverStyle();h=2;i.setWidgetHoverStyle(!0)}e.stopPropagation()}};t.ondragleave=function(e){var t=e.clientX,n=e.clientY,o=document.elementFromPoint(t,n);0===t&&0===n&&(o=null);if(o!==m)i.resetDragDrop();else{i.setWidgetHoverStyle(!1);h=1}};t.ondragover=function(e){e.preventDefault()};bodyDragEnter=function(e){if((f||c)&&"none"!==o.css(t,"display")&&u){h=1;i.setPageHoverStyle()}};document.body.addEventListener("dragenter",bodyDragEnter);m.ondragover=function(e){e.preventDefault();e.stopPropagation()};m.ondragleave=function(e){u&&1==h&&i.resetDragDrop()};m.ondrop=function(e){e.preventDefault();c?t.ondrop(e):i.resetDragDrop()};t.ondrop=function(e){e.preventDefault();if(u){i.resetDragDrop();void 0!==window.FormData&&null!==e.dataTransfer.files&&0!==e.dataTransfer.files.length&&i.addFiles(e.dataTransfer.files)}};this.addFiles=function(n){for(var i=[],o=0;o<n.length;o++){var a=new Object;a.id=Math.floor(Math.random()*Math.pow(2,31));a.file=n[o];d.push(a);var r={};r.id=a.id;r.filename=a.file.name;r.type=a.file.type;r.size=a.file.size;i.push(r)}e.emit(t,"dropsignal",JSON.stringify(i))};t.addEventListener("click",(function(e){if(u){g.value="";g.click()}}));t.markForSending=function(e){for(var t=0;t<e.length;t++)for(var n=e[t].id,o=0;o<d.length;o++)if(d[o].id===n){d[o].ready=!0;break}l||d[0].ready&&i.requestSend()};this.requestSend=function(){if(d[0].skip)i.uploadFinished(null);else{l=!0;e.emit(t,"requestsend",d[0].id)}};t.send=function(o,a){upload=d[0];if(upload.file.size>n){e.emit(t,"filetoolarge",upload.file.size);i.uploadFinished(null)}else{var r=null!=p&&a?i.workerSend:i.actualSend;i.validFileCheck(upload.file,r,o)}};this.actualSend=function(e,t){if(e){var n=new XMLHttpRequest;n.addEventListener("load",i.uploadFinished);n.addEventListener("error",i.uploadFinished);n.addEventListener("abort",i.uploadFinished);n.addEventListener("timeout",i.uploadFinished);n.open("POST",t);d[0].request=n;var o=new FormData;o.append("file-id",d[0].id);o.append("data",d[0].file);n.send(o)}else i.uploadFinished(null)};this.workerSend=function(e,t){if(e){p.upload=d[0];p.postMessage({cmd:"send",url:t,upload:d[0],chunksize:v})}else i.uploadFinished(null)};this.uploadFinished=function(n){(null!=n&&"load"===n.type&&200===n.currentTarget.status||!0===n)&&e.emit(t,"uploadfinished",d[0].id);d.splice(0,1);if(d[0]&&d[0].ready)i.requestSend();else{l=!1;e.emit(t,"donesending")}};t.cancelUpload=function(e){if(d[0]&&d[0].id===e){d[0].skip=!0;d[0].request?d[0].request.abort():p&&p.upload===d[0]&&p.postMessage({cmd:"cancel",upload:d[0]})}else for(var t=1;t<d.length;t++)d[t].id===e&&(d[t].skip=!0)};g.onchange=function(){u&&void 0!==window.FormData&&null!==this.files&&0!==this.files.length&&i.addFiles(this.files)};this.setPageHoverStyle=function(){if(f||c){m.classList.add(s);t.classList.add(s);f&&t.classList.add(r)}};this.setWidgetHoverStyle=function(e){t.classList.toggle(a,e)};this.resetDragDrop=function(){t.classList.remove(r);t.classList.remove(s);m.classList.remove(s);i.setWidgetHoverStyle(!1);h=0};t.configureHoverClass=function(e){a=e};t.setFilters=function(e){g.setAttribute("accept",e)};t.setUploadWorker=function(n){if(n&&window.Worker){(p=new Worker(n)).onmessage=function(n){if(n.data.workerfeatures){if("valid"!==n.data.workerfeatures){t.setUploadWorker(null);e.emit(t,"filternotsupported")}}else i.uploadFinished(n.data)};p.postMessage({cmd:"check"})}else p=void 0};t.setChunkSize=function(e){v=e};t.destructor=function(){document.body.removeEventListener("dragenter",bodyDragEnter);document.body.removeChild(m)}}));