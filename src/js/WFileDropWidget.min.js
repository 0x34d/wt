WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",(function(e,t,n){t.wtLObj=this;var i=this,a=(e.WT,"Wt-dropzone-hover"),o="Wt-dropzone-indication",r="Wt-dropzone-dragstyle",d=[],s=!1,l=!0,u=!1,f=!1,p=void 0,c=0,v=0,h=document.createElement("input");h.type="file";h.setAttribute("multiple","multiple");$(h).hide();t.appendChild(h);var g=document.createElement("div");$(g).addClass("Wt-dropcover");document.body.appendChild(g);this.eventContainsFile=function(e){var t=null!=e.dataTransfer.items&&e.dataTransfer.items.length>0&&"file"===e.dataTransfer.items[0].kind,n=null!=e.dataTransfer.types&&e.dataTransfer.types.length>0&&"Files"===e.dataTransfer.types[0];return t||n};this.validFileCheck=function(e,t,n){var i=new FileReader;i.onload=function(){t(!0,n)};i.onerror=function(){t(!1,n)};i.readAsText(e.slice(0,32))};t.setAcceptDrops=function(e){l=e};t.setDropIndication=function(e){u=e};t.setDropForward=function(e){f=e};t.ondragenter=function(e){if(l){if(i.eventContainsFile(e)){0===v&&i.setPageHoverStyle();v=2;i.setWidgetHoverStyle(!0)}e.stopPropagation()}};t.ondragleave=function(e){var t=e.clientX,n=e.clientY,a=document.elementFromPoint(t,n);0===t&&0===n&&(a=null);if(a!==g)i.resetDragDrop();else{i.setWidgetHoverStyle(!1);v=1}};t.ondragover=function(e){e.preventDefault()};bodyDragEnter=function(e){if((u||f)&&$(t).is(":visible")&&l){v=1;i.setPageHoverStyle()}};document.body.addEventListener("dragenter",bodyDragEnter);g.ondragover=function(e){e.preventDefault();e.stopPropagation()};g.ondragleave=function(e){l&&1==v&&i.resetDragDrop()};g.ondrop=function(e){e.preventDefault();f?t.ondrop(e):i.resetDragDrop()};t.ondrop=function(e){e.preventDefault();if(l){i.resetDragDrop();void 0!==window.FormData&&null!==e.dataTransfer.files&&0!==e.dataTransfer.files.length&&i.addFiles(e.dataTransfer.files)}};this.addFiles=function(n){for(var i=[],a=0;a<n.length;a++){var o=new Object;o.id=Math.floor(Math.random()*Math.pow(2,31));o.file=n[a];d.push(o);var r={};r.id=o.id;r.filename=o.file.name;r.type=o.file.type;r.size=o.file.size;i.push(r)}e.emit(t,"dropsignal",JSON.stringify(i))};t.addEventListener("click",(function(e){if(l){$(h).val("");h.click()}}));t.markForSending=function(e){for(var t=0;t<e.length;t++)for(var n=e[t].id,a=0;a<d.length;a++)if(d[a].id===n){d[a].ready=!0;break}s||d[0].ready&&i.requestSend()};this.requestSend=function(){if(d[0].skip)i.uploadFinished(null);else{s=!0;e.emit(t,"requestsend",d[0].id)}};t.send=function(a,o){upload=d[0];if(upload.file.size>n){e.emit(t,"filetoolarge",upload.file.size);i.uploadFinished(null)}else{var r=null!=p&&o?i.workerSend:i.actualSend;i.validFileCheck(upload.file,r,a)}};this.actualSend=function(e,t){if(e){var n=new XMLHttpRequest;n.addEventListener("load",i.uploadFinished);n.addEventListener("error",i.uploadFinished);n.addEventListener("abort",i.uploadFinished);n.addEventListener("timeout",i.uploadFinished);n.open("POST",t);d[0].request=n;var a=new FormData;a.append("file-id",d[0].id);a.append("data",d[0].file);n.send(a)}else i.uploadFinished(null)};this.workerSend=function(e,t){if(e){p.upload=d[0];p.postMessage({cmd:"send",url:t,upload:d[0],chunksize:c})}else i.uploadFinished(null)};this.uploadFinished=function(n){(null!=n&&"load"===n.type&&200===n.currentTarget.status||!0===n)&&e.emit(t,"uploadfinished",d[0].id);d.splice(0,1);if(d[0]&&d[0].ready)i.requestSend();else{s=!1;e.emit(t,"donesending")}};t.cancelUpload=function(e){if(d[0]&&d[0].id===e){d[0].skip=!0;d[0].request?d[0].request.abort():p&&p.upload===d[0]&&p.postMessage({cmd:"cancel",upload:d[0]})}else for(var t=1;t<d.length;t++)d[t].id===e&&(d[t].skip=!0)};h.onchange=function(){l&&void 0!==window.FormData&&null!==this.files&&0!==this.files.length&&i.addFiles(this.files)};this.setPageHoverStyle=function(){if(u||f){$(g).addClass(r);$(t).addClass(r);u&&$(t).addClass(o)}};this.setWidgetHoverStyle=function(e){e?$(t).addClass(a):$(t).removeClass(a)};this.resetDragDrop=function(){$(t).removeClass(o);$(t).removeClass(r);$(g).removeClass(r);i.setWidgetHoverStyle(!1);v=0};t.configureHoverClass=function(e){a=e};t.setFilters=function(e){h.setAttribute("accept",e)};t.setUploadWorker=function(n){if(n&&window.Worker){(p=new Worker(n)).onmessage=function(n){if(n.data.workerfeatures){if("valid"!==n.data.workerfeatures){t.setUploadWorker(null);e.emit(t,"filternotsupported")}}else i.uploadFinished(n.data)};p.postMessage({cmd:"check"})}else p=void 0};t.setChunkSize=function(e){c=e};t.destructor=function(){document.body.removeEventListener("dragenter",bodyDragEnter);document.body.removeChild(g)}}));